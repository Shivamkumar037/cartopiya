<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cartopiya Shop</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 3. Toastify Notifications -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#059669',
                        secondary: '#10b981',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: sans-serif; background-color: #f8fafc; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Loader */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #059669;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Hide Scrollbar */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Force Hide/Show Utility */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
    </style>
</head>
<body class="text-slate-800">

    <!-- CRITICAL: Fallback message if JS is disabled -->
    <noscript>
        <div style="padding: 20px; text-align: center; color: red;">
            Please enable JavaScript to use this app.
        </div>
    </noscript>

    <!-- LOADING SCREEN (Visible by default, removed by JS) -->
    <div id="initial-loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <h2 class="text-lg font-bold text-slate-700">Loading App...</h2>
        <p class="text-xs text-slate-400 mt-2">v1.2 Stable</p>
        <button onclick="localStorage.clear(); location.reload()" class="mt-8 text-xs text-red-400 underline">Stuck? Click to Reset</button>
    </div>

    <!-- 1. LOGIN SCREEN (Hidden initially via CSS) -->
    <div id="login-screen" class="d-none fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="flex flex-col items-center mb-10">
                <div class="bg-primary text-white p-4 rounded-full shadow-lg mb-4">
                    <i class="fa-solid fa-bag-shopping text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-800">Cartopiya</h1>
                <p class="text-slate-500">Welcome Back</p>
            </div>

            <form onsubmit="handleLogin(event)" class="space-y-4 w-full">
                <input type="text" id="login-name" required placeholder="Enter Full Name" 
                    class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-primary outline-none">
                
                <input type="tel" id="login-mobile" required pattern="[0-9]{10}" placeholder="Mobile Number" 
                    class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-primary outline-none">
                
                <button type="submit" id="login-btn" class="w-full bg-primary text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition">
                    Start Shopping
                </button>
            </form>
        </div>
    </div>

    <!-- 2. MAIN APP (Hidden initially via CSS) -->
    <div id="app-layout" class="d-none min-h-screen flex flex-col pb-20 md:pb-0">
        
        <!-- Header -->
        <header class="bg-white sticky top-0 z-40 border-b px-4 py-3 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-2 font-bold text-lg text-primary">
                <i class="fa-solid fa-bag-shopping"></i> Cartopiya
            </div>
            
            <!-- Desktop Nav -->
            <div class="hidden md:flex gap-6 text-sm font-medium text-slate-600">
                <button onclick="router('home')" class="hover:text-primary">Home</button>
                <button onclick="router('orders')" class="hover:text-primary">Orders</button>
                <button onclick="router('cart')" class="hover:text-primary">Cart</button>
                <button onclick="handleLogout()" class="text-red-500">Logout</button>
            </div>

            <!-- Mobile User Icon -->
            <div class="md:hidden w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-primary" onclick="router('account')">
                <i class="fa-solid fa-user"></i>
            </div>
        </header>

        <!-- Content Area -->
        <main class="flex-grow p-4 max-w-6xl mx-auto w-full">
            
            <!-- SECTION: HOME -->
            <div id="home" class="page-section">
                <!-- Search -->
                <div class="relative mb-6">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-400"></i>
                    <input type="text" id="search-input" onkeyup="handleSearch()" placeholder="Search products..." class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl shadow-sm outline-none focus:border-primary">
                </div>

                <!-- Products Grid -->
                <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- JS fills this -->
                </div>

                <!-- Loaders / Messages -->
                <div id="grid-loader" class="py-10 text-center text-slate-500 hidden">Loading Products...</div>
                <div id="no-data" class="py-10 text-center text-slate-400 hidden">No products found.</div>
            </div>

            <!-- SECTION: DETAILS -->
            <div id="product-details" class="page-section d-none">
                <button onclick="router('home')" class="mb-4 bg-white px-3 py-1 rounded border text-sm"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <div id="detail-container"></div>
            </div>

            <!-- SECTION: CART -->
            <div id="cart" class="page-section d-none">
                <h2 class="text-xl font-bold mb-4">My Cart <span id="cart-count-badge" class="text-sm font-normal text-slate-500">(0)</span></h2>
                <div id="cart-list" class="space-y-3"></div>
                <div id="cart-empty" class="py-10 text-center text-slate-400 hidden">Your cart is empty.</div>
            </div>

            <!-- SECTION: ORDERS -->
            <div id="orders" class="page-section d-none">
                <h2 class="text-xl font-bold mb-4">History</h2>
                <div id="order-list" class="space-y-3"></div>
                <div id="order-empty" class="py-10 text-center text-slate-400 hidden">No history found.</div>
            </div>

            <!-- SECTION: ACCOUNT -->
            <div id="account" class="page-section d-none">
                <div class="bg-white p-6 rounded-xl shadow-sm border text-center">
                    <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl text-primary font-bold">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <h2 id="user-name-disp" class="text-xl font-bold">User</h2>
                    <p id="user-mobile-disp" class="text-slate-500 text-sm">Mobile</p>
                    <button onclick="handleLogout()" class="mt-6 w-full bg-red-50 text-red-500 py-2 rounded-lg font-bold">Logout</button>
                </div>
            </div>
        </main>

        <!-- Mobile Bottom Nav -->
        <nav class="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-around py-2 z-50 text-[10px] text-slate-500 shadow-lg">
            <div onclick="router('home')" class="nav-btn flex flex-col items-center p-2 w-full">
                <i class="fa-solid fa-house text-lg mb-1"></i> Home
            </div>
            <div onclick="router('cart')" class="nav-btn flex flex-col items-center p-2 w-full relative">
                <i class="fa-solid fa-cart-shopping text-lg mb-1"></i> Cart
                <span id="mobile-cart-badge" class="absolute top-1 right-6 bg-red-500 text-white w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
            </div>
            <div onclick="router('orders')" class="nav-btn flex flex-col items-center p-2 w-full">
                <i class="fa-solid fa-box text-lg mb-1"></i> Orders
            </div>
            <div onclick="router('account')" class="nav-btn flex flex-col items-center p-2 w-full">
                <i class="fa-solid fa-user text-lg mb-1"></i> Profile
            </div>
        </nav>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // --- SAFE INITIALIZATION ---
        // Global variables with safe defaults
        const API_URL = "https://pdf-editor-vtsg.onrender.com";
        let user = null;
        let products = [];
        let cart = [];
        let history = [];

        // Error Handler
        window.onerror = function(msg, url, line) {
            alert("App Error: " + msg + "\nTry clicking 'Reset' on the loading screen.");
        };

        // --- STARTUP LOGIC ---
        window.addEventListener('load', () => {
            try {
                // 1. Load Data safely
                loadLocalData();
                
                // 2. Hide Loader
                document.getElementById('initial-loader').classList.add('d-none');

                // 3. Route
                if (user) {
                    showApp();
                } else {
                    document.getElementById('login-screen').classList.remove('d-none');
                }
            } catch (e) {
                console.error("Init Error", e);
                // Fallback: Clear data and reload if critical fail
                if(confirm("App data seems corrupted. Reset now?")) {
                    localStorage.clear();
                    location.reload();
                }
            }
        });

        function loadLocalData() {
            try {
                user = JSON.parse(localStorage.getItem('app_user'));
                cart = JSON.parse(localStorage.getItem('app_cart')) || [];
                history = JSON.parse(localStorage.getItem('app_history')) || [];
            } catch (e) {
                console.warn("Data corrupted, resetting.");
                localStorage.clear();
            }
        }

        // --- AUTHENTICATION ---
        function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            btn.innerText = "Please wait...";
            btn.disabled = true;

            const name = document.getElementById('login-name').value;
            const mobile = document.getElementById('login-mobile').value;

            // Save User
            user = { username: name, mobile: mobile };
            localStorage.setItem('app_user', JSON.stringify(user));

            // Fire API (Background)
            fetch(`${API_URL}/userdata`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(user)
            }).catch(e => console.log("Offline login"));

            setTimeout(() => {
                document.getElementById('login-screen').classList.add('d-none');
                showApp();
            }, 800);
        }

        function handleLogout() {
            if(confirm("Logout?")) {
                localStorage.removeItem('app_user');
                location.reload();
            }
        }

        // --- CORE APP ---
        function showApp() {
            document.getElementById('app-layout').classList.remove('d-none');
            document.getElementById('app-layout').classList.add('d-flex');
            
            // Set User Info
            document.getElementById('user-name-disp').innerText = user.username;
            document.getElementById('user-mobile-disp').innerText = user.mobile;
            
            updateCartUI();
            fetchProducts();
        }

        async function fetchProducts() {
            const grid = document.getElementById('product-grid');
            const loader = document.getElementById('grid-loader');
            const noData = document.getElementById('no-data');

            grid.innerHTML = '';
            loader.classList.remove('hidden');
            noData.classList.add('hidden');

            try {
                // Timeout after 4 seconds to prevent hanging
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 4000);

                const res = await fetch(`${API_URL}/productdata`, { signal: controller.signal });
                clearTimeout(id);
                
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                
                products = Array.isArray(data) ? data : [data];
                
                if(products.length === 0) throw new Error("No Products");
                renderGrid(products);

            } catch (error) {
                console.log("Using Demo Data");
                // DEMO DATA FALLBACK
                products = [
                    { id: 1, productname: "Premium Watch", price: 2500, description: "Luxury analog watch.", imglink: "https://images.unsplash.com/photo-1524592094765-f722b2c0b055?w=400" },
                    { id: 2, productname: "Wireless Buds", price: 1299, description: "Noise cancellation.", imglink: "https://images.unsplash.com/photo-1590658268037-6bf12165a8df?w=400" },
                    { id: 3, productname: "Sneakers", price: 3400, description: "Running shoes.", imglink: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400" },
                    { id: 4, productname: "Camera", price: 45000, description: "DSLR 4k.", imglink: "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=400" }
                ];
                renderGrid(products);
                if(window.Toastify) Toastify({text: "Demo Mode (Server Offline)", duration: 3000, style:{background:"#f59e0b"}}).showToast();
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderGrid(list) {
            const grid = document.getElementById('product-grid');
            if(list.length === 0) {
                document.getElementById('no-data').classList.remove('hidden');
                return;
            }
            grid.innerHTML = list.map(p => `
                <div class="bg-white rounded-lg shadow-sm border overflow-hidden cursor-pointer hover:shadow-md transition" onclick="showDetails(${p.id})">
                    <div class="h-40 bg-slate-50 relative">
                        <img src="${p.imglink}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200'">
                        <span class="absolute bottom-1 right-1 bg-white px-2 py-0.5 text-xs font-bold rounded shadow">₹${p.price}</span>
                    </div>
                    <div class="p-3">
                        <h3 class="font-bold text-sm truncate">${p.productname}</h3>
                        <p class="text-xs text-slate-500 truncate">${p.description}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- NAVIGATION ---
        function router(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('block')); // Safe cleanup

            // Show target
            const page = document.getElementById(pageId);
            page.classList.remove('d-none');
            page.classList.add('block');
            window.scrollTo(0,0);

            // Update Nav Icons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.innerText.toLowerCase().includes(pageId)) btn.classList.add('text-primary');
                else btn.classList.remove('text-primary');
            });

            if(pageId === 'cart') renderCart();
            if(pageId === 'orders') renderHistory();
        }

        // --- DETAILS ---
        function showDetails(id) {
            const product = products.find(p => p.id == id);
            if(!product) return;
            const link = product.productlink || '#';

            document.getElementById('detail-container').innerHTML = `
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="h-64 bg-slate-50 flex items-center justify-center">
                         <img src="${product.imglink}" class="h-full object-contain" onerror="this.src='https://placehold.co/400'">
                    </div>
                    <div class="p-5">
                        <h1 class="text-2xl font-bold">${product.productname}</h1>
                        <p class="text-3xl text-primary font-bold my-2">₹${product.price}</p>
                        <p class="text-slate-600 mb-6">${product.description}</p>
                        <div class="flex gap-3">
                            <button onclick="addToCart(${product.id})" class="flex-1 bg-slate-100 py-3 rounded-lg font-bold">Add to Cart</button>
                            <a href="${link}" target="_blank" onclick="addToHistory(${product.id})" class="flex-1 bg-primary text-white flex items-center justify-center py-3 rounded-lg font-bold">Buy Now</a>
                        </div>
                    </div>
                </div>
            `;
            router('product-details');
        }

        // --- CART & HISTORY ---
        function addToCart(id) {
            const p = products.find(x => x.id == id);
            if(p) {
                cart.push(p);
                saveData();
                updateCartUI();
                if(window.Toastify) Toastify({text: "Added to Cart", duration: 2000, style:{background:"#059669"}}).showToast();
            }
        }

        function addToHistory(id) {
            const p = products.find(x => x.id == id);
            if(p) {
                history.unshift({...p, date: new Date().toLocaleDateString()});
                saveData();
            }
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            saveData();
            renderCart();
            updateCartUI();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const empty = document.getElementById('cart-empty');
            
            if(cart.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                list.innerHTML = cart.map((item, idx) => `
                    <div class="bg-white p-3 rounded shadow-sm border flex gap-3 relative">
                        <img src="${item.imglink}" class="w-16 h-16 object-cover rounded bg-slate-100">
                        <div>
                            <h4 class="font-bold text-sm">${item.productname}</h4>
                            <span class="text-primary font-bold">₹${item.price}</span>
                            <div class="mt-1"><a href="${item.productlink||'#'}" target="_blank" class="text-xs bg-slate-800 text-white px-2 py-1 rounded">Buy</a></div>
                        </div>
                        <button onclick="removeFromCart(${idx})" class="absolute top-2 right-2 text-red-400"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `).join('');
            }
        }

        function renderHistory() {
            const list = document.getElementById('order-list');
            const empty = document.getElementById('order-empty');
            
            if(history.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                list.innerHTML = history.map(item => `
                    <div class="bg-white p-3 rounded shadow-sm border flex gap-3 opacity-75">
                         <img src="${item.imglink}" class="w-14 h-14 object-cover rounded bg-slate-100 grayscale">
                         <div>
                            <h4 class="font-bold text-sm">${item.productname}</h4>
                            <a href="${item.productlink||'#'}" target="_blank" class="text-xs text-blue-500">Visit Link Again</a>
                         </div>
                    </div>
                `).join('');
            }
        }

        function updateCartUI() {
            const count = cart.length;
            document.getElementById('cart-count-badge').innerText = `(${count})`;
            const mobileBadge = document.getElementById('mobile-cart-badge');
            if(count > 0) {
                mobileBadge.innerText = count;
                mobileBadge.classList.remove('hidden');
            } else {
                mobileBadge.classList.add('hidden');
            }
        }

        function saveData() {
            localStorage.setItem('app_cart', JSON.stringify(cart));
            localStorage.setItem('app_history', JSON.stringify(history));
        }

        function handleSearch() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const filtered = products.filter(p => p.productname.toLowerCase().includes(q));
            renderGrid(filtered);
        }
    </script>
</body>
</html>


