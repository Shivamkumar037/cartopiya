<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-item.active { background-color: #2563eb; color: white; }
        /* Modal Overlay */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 text-slate-300 flex-shrink-0 hidden md:flex flex-col" id="sidebar">
        <div class="h-16 flex items-center justify-center border-b border-slate-800 bg-slate-950">
            <h1 class="text-xl font-bold text-white">ADMIN<span class="text-blue-500">PANEL</span></h1>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-chart-line w-6"></i> Dashboard
            </a>
            <a href="#" onclick="switchTab('products')" id="nav-products" class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-box-open w-6"></i> Products
            </a>
            <a href="#" onclick="switchTab('users')" id="nav-users" class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-users w-6"></i> Users
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-10">
            <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-600 rounded-lg"><i class="fa-solid fa-bars text-xl"></i></button>
            <h2 class="text-lg font-semibold text-slate-700">Dashboard</h2>
            <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold border border-blue-200">A</div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-6 relative">
            
            <div id="toast" class="fixed top-20 right-6 z-50 transform transition-all duration-300 translate-x-full opacity-0">
                <div class="bg-white border-l-4 border-green-500 shadow-lg rounded-r px-4 py-3 flex items-center">
                    <i class="fa-solid fa-circle-check text-green-500 mr-3 text-xl"></i>
                    <p class="text-sm font-bold text-slate-800" id="toast-message">Success</p>
                </div>
            </div>

            <div id="global-loader" class="hidden absolute inset-0 bg-white/80 z-40 flex items-center justify-center">
                <div class="loader w-10 h-10 border-4"></div>
            </div>

            <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
                <div class="bg-white rounded-lg shadow-xl w-96 p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-800">Update Product Price</h3>
                    <input type="hidden" id="edit-product-id">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">New Price (₹)</label>
                        <input type="number" id="edit-product-price" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="closeEditModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                        <button onclick="submitPriceUpdate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                    </div>
                </div>
            </div>

            <div id="section-dashboard">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center">
                        <div class="p-4 rounded-full bg-indigo-50 text-indigo-600 mr-4"><i class="fa-solid fa-users text-2xl"></i></div>
                        <div><p class="text-sm text-slate-500">Total Users</p><h3 class="text-2xl font-bold" id="stat-users">0</h3></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center">
                        <div class="p-4 rounded-full bg-emerald-50 text-emerald-600 mr-4"><i class="fa-solid fa-box-open text-2xl"></i></div>
                        <div><p class="text-sm text-slate-500">Total Products</p><h3 class="text-2xl font-bold" id="stat-products">0</h3></div>
                    </div>
                </div>
            </div>

            <div id="section-products" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-700">All Products</h3>
                    <button onclick="toggleProductForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                        <i class="fa-solid fa-plus mr-2"></i> Add Product
                    </button>
                </div>

                <div id="product-form-container" class="hidden bg-white p-6 rounded-xl shadow-md border mb-8">
                    <h4 class="text-lg font-semibold mb-4 border-b pb-2">Upload New Product</h4>
                    <form id="addProductForm" onsubmit="handleProductSubmit(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm text-slate-700 mb-1">Product Name</label>
                                <input type="text" name="productname" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-slate-700 mb-1">Price (₹)</label>
                                <input type="number" name="price" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm text-slate-700 mb-1">Description</label>
                                <textarea name="description" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm text-slate-700 mb-1">Product Link (Affiliate)</label>
                                <input type="url" name="productlink" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-slate-700 mb-1">Product Image (File)</label>
                                <input type="file" name="image" accept="image/*" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" onclick="toggleProductForm()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button type="submit" id="submit-btn" class="px-6 py-2 bg-slate-900 text-white hover:bg-slate-800 rounded-lg flex items-center">
                                <span id="btn-text">Upload Product</span>
                                <div id="btn-loader" class="loader ml-2 w-4 h-4 border-2 border-t-white hidden"></div>
                            </button>
                        </div>
                    </form>
                </div>

                <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div id="products-empty" class="hidden text-center py-12 bg-white rounded-xl border border-dashed"><p class="text-slate-500">No products found.</p></div>
            </div>

            <div id="section-users" class="hidden">
                <h3 class="text-xl font-bold text-slate-700 mb-4">Registered Users</h3>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500">ID</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500">User</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500">Mobile</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_BASE_URL = "https://pdf-editor-vtsg.onrender.com"; // Your Backend URL

        // --- Navigation ---
        const sections = {
            dashboard: document.getElementById('section-dashboard'),
            products: document.getElementById('section-products'),
            users: document.getElementById('section-users')
        };
        const navItems = {
            dashboard: document.getElementById('nav-dashboard'),
            products: document.getElementById('nav-products'),
            users: document.getElementById('nav-users')
        };

        function switchTab(tab) {
            Object.values(sections).forEach(el => el.classList.add('hidden'));
            Object.values(navItems).forEach(el => el.classList.remove('active', 'bg-blue-600', 'text-white'));
            
            sections[tab].classList.remove('hidden');
            navItems[tab].classList.add('active');
            
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('hidden'); sb.classList.toggle('absolute'); sb.classList.toggle('z-50'); sb.classList.toggle('h-full');
        }

        function toggleProductForm() {
            document.getElementById('product-form-container').classList.toggle('hidden');
        }

        // --- Data Fetching ---
        window.addEventListener('DOMContentLoaded', fetchData);

        async function fetchData() {
            document.getElementById('global-loader').classList.remove('hidden');
            try {
                const [userRes, prodRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/userdata`),
                    fetch(`${API_BASE_URL}/productdata`)
                ]);
                const users = await userRes.json();
                const products = await prodRes.json();

                renderDashboard(users, products);
                renderUsers(users);
                renderProducts(products);
            } catch (err) {
                console.error(err);
                showToast("Error loading data", "error");
            } finally {
                document.getElementById('global-loader').classList.add('hidden');
            }
        }

        function renderDashboard(users, products) {
            document.getElementById('stat-users').innerText = users.length || 0;
            document.getElementById('stat-products').innerText = products.length || 0;
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = users.map(u => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 text-sm text-slate-500">#${u.id}</td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-800">${u.username || 'Unknown'}</td>
                    <td class="px-6 py-4 text-sm text-slate-600 font-mono">${u.mobile || 'N/A'}</td>
                </tr>
            `).join('');
        }

        function renderProducts(products) {
            const grid = document.getElementById('products-grid');
            const empty = document.getElementById('products-empty');
            
            if (!products || products.length === 0) {
                grid.innerHTML = ''; empty.classList.remove('hidden'); return;
            }
            empty.classList.add('hidden');

            grid.innerHTML = products.map(p => `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow flex flex-col">
                    <div class="h-48 w-full bg-slate-100 relative group overflow-hidden">
                        <img src="${p.imglink}" onerror="this.src='https://placehold.co/400x300?text=No+Image'" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800 line-clamp-1">${p.productname}</h4>
                        </div>
                        <p class="text-sm text-slate-500 line-clamp-2 mb-4">${p.description}</p>
                        <div class="mt-auto flex justify-between items-center border-t pt-3">
                            <span class="text-lg font-bold text-blue-600">₹${p.price}</span>
                            <div class="flex gap-2">
                                <button onclick="openEditModal(${p.id}, ${p.price})" class="text-blue-500 hover:bg-blue-50 p-2 rounded-full" title="Edit Price">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="deleteProduct(${p.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-full" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- Upload Product (Modified for Multipart) ---
        async function handleProductSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('submit-btn');
            const loader = document.getElementById('btn-loader');
            
            btn.disabled = true; loader.classList.remove('hidden');

            const formData = new FormData(form);
            
            // Backend expects 2 parts: 'product' (JSON) and 'image' (File)
            const apiData = new FormData();

            // 1. Image Part
            const imageFile = formData.get('image');
            apiData.append('image', imageFile);

            // 2. Product JSON Part
            const productJson = {
                productname: formData.get('productname'),
                description: formData.get('description'),
                productlink: formData.get('productlink'),
                price: parseFloat(formData.get('price'))
            };
            
            // Append JSON as a Blob with application/json type
            apiData.append('product', new Blob([JSON.stringify(productJson)], {
                type: 'application/json'
            }));

            try {
                const res = await fetch(`${API_BASE_URL}/productdata`, {
                    method: 'POST',
                    body: apiData // No Content-Type header manually, fetch does it for FormData
                });

                if (res.ok) {
                    showToast("Product Uploaded!", "success");
                    form.reset();
                    toggleProductForm();
                    fetchData();
                } else {
                    throw new Error("Upload Failed");
                }
            } catch (err) {
                showToast("Failed to upload", "error");
                console.error(err);
            } finally {
                btn.disabled = false; loader.classList.add('hidden');
            }
        }

        // --- Delete Product ---
        async function deleteProduct(id) {
            if(!confirm("Are you sure you want to delete this product?")) return;

            try {
                const res = await fetch(`${API_BASE_URL}/productdata/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    showToast("Product Deleted", "success");
                    fetchData();
                } else throw new Error("Delete failed");
            } catch(err) {
                showToast("Could not delete", "error");
            }
        }

        // --- Edit Price Logic ---
        function openEditModal(id, currentPrice) {
            document.getElementById('edit-product-id').value = id;
            document.getElementById('edit-product-price').value = currentPrice;
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        async function submitPriceUpdate() {
            const id = document.getElementById('edit-product-id').value;
            const price = document.getElementById('edit-product-price').value;

            if(!price) return alert("Enter a price");

            try {
                // Backend: PUT /productdata/{id}/price?price=XX
                const res = await fetch(`${API_BASE_URL}/productdata/${id}/price?price=${price}`, {
                    method: 'PUT'
                });

                if(res.ok) {
                    showToast("Price Updated", "success");
                    closeEditModal();
                    fetchData();
                } else throw new Error("Update failed");
            } catch(err) {
                showToast("Update Failed", "error");
            }
        }

        // --- Toast Util ---
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.querySelector('i').className = type === 'error' ? 'fa-solid fa-circle-exclamation text-red-500 mr-3 text-xl' : 'fa-solid fa-circle-check text-green-500 mr-3 text-xl';
            t.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => t.classList.add('translate-x-full', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
